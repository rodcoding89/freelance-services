# ========================
# Build stage
# ========================
FROM node:20-alpine AS build

WORKDIR /app

COPY package*.json ./
RUN npm config set fetch-retry-maxtimeout 120000 \
 && npm config set fetch-timeout 120000 \
 && npm install --frozen-lockfile

COPY . .

ENV NODE_OPTIONS="--max-old-space-size=4096"

ARG NEXT_PUBLIC_ENV
ARG NEXT_PUBLIC_FREELANCE_EMAIL
ARG NEXT_PUBLIC_ROOT_LINK
ARG NEXT_PUBLIC_COMPANY_NAME
ARG NEXT_PUBLIC_COMPANY_ADRESS_STREET
ARG NEXT_PUBLIC_COMPANY_ADRESS_POSTAL_CODE
ARG NEXT_PUBLIC_COMPANY_ADRESS_CITY
ARG NEXT_PUBLIC_COMPANY_ADRESS_COUNTRY
ARG NEXT_PUBLIC_COMPANY_PHONE
ARG NEXT_PUBLIC_WEB_LINK
ARG NEXT_PUBLIC_TAX_ID
ARG NEXT_PUBLIC_PAYMENT_LINK
ARG NEXT_PUBLIC_COMPANY_LOCALE_ADRESS_STREET
ARG NEXT_PUBLIC_COMPANY_LOCALE_ADRESS_CITY
ARG NEXT_PUBLIC_COMPANY_LOCALE_ADRESS_POSTAL_CODE
ARG NEXT_PUBLIC_COMPANY_LOCALE_ADRESS_COUNTRY
ARG NEXT_PUBLIC_COMPANY_AUTHOR
ARG NEXT_PUBLIC_HOSTING_PROVIDER
ARG NEXT_PUBLIC_HOSTING_URL
ARG NEXT_PUBLIC_HOSTING_PROVIDER_ADRESSE
ARG NEXT_PUBLIC_HOSTING_PROVIDER_TEL
ARG NEXT_PUBLIC_HOSTING_PROVIDER_URL
ARG NEXT_PUBLIC_MAINTENACE_WEBSITE_COST_PER_HOUR
ARG NEXT_PUBLIC_MAINTENACE_WEBSITE_COST_PER_YEAR
ARG NEXT_PUBLIC_MAINTENACE_ECOMMERCE_COST_PER_HOUR
ARG NEXT_PUBLIC_MAINTENACE_ECOMMERCE_COST_PER_YEAR
ARG NEXT_PUBLIC_MAKE_CONTRACT_CITY
ARG NEXT_PUBLIC_DEV_ECOMMERCE_COST_CMS
ARG NEXT_PUBLIC_DEV_ECOMMERCE_COST_HEALESS_CMS
ARG NEXT_PUBLIC_DEV_ECOMMERCE_COST_CUSTOM
ARG NEXT_PUBLIC_DEV_WEBSITE_COST_CMS
ARG NEXT_PUBLIC_DEV_WEBSITE_COST_HEALESS_CMS
ARG NEXT_PUBLIC_DEV_WEBSITE_COST_CUSTOM

ENV NEXT_PUBLIC_ENV=${NEXT_PUBLIC_ENV}
ENV NEXT_PUBLIC_FREELANCE_EMAIL=${NEXT_PUBLIC_FREELANCE_EMAIL}
ENV NEXT_PUBLIC_ROOT_LINK=${NEXT_PUBLIC_ROOT_LINK}
ENV NEXT_PUBLIC_COMPANY_NAME=${NEXT_PUBLIC_COMPANY_NAME}
ENV NEXT_PUBLIC_COMPANY_ADRESS_STREET=${NEXT_PUBLIC_COMPANY_ADRESS_STREET}
ENV NEXT_PUBLIC_COMPANY_ADRESS_POSTAL_CODE=${NEXT_PUBLIC_COMPANY_ADRESS_POSTAL_CODE}
ENV NEXT_PUBLIC_COMPANY_ADRESS_CITY=${NEXT_PUBLIC_COMPANY_ADRESS_CITY}
ENV NEXT_PUBLIC_COMPANY_ADRESS_COUNTRY=${NEXT_PUBLIC_COMPANY_ADRESS_COUNTRY}
ENV NEXT_PUBLIC_COMPANY_PHONE=${NEXT_PUBLIC_COMPANY_PHONE}
ENV NEXT_PUBLIC_WEB_LINK=${NEXT_PUBLIC_WEB_LINK}
ENV NEXT_PUBLIC_TAX_ID=${NEXT_PUBLIC_TAX_ID}
ENV NEXT_PUBLIC_PAYMENT_LINK=${NEXT_PUBLIC_PAYMENT_LINK}
ENV NEXT_PUBLIC_COMPANY_LOCALE_ADRESS_STREET=${NEXT_PUBLIC_COMPANY_LOCALE_ADRESS_STREET}
ENV NEXT_PUBLIC_COMPANY_LOCALE_ADRESS_CITY=${NEXT_PUBLIC_COMPANY_LOCALE_ADRESS_CITY}
ENV NEXT_PUBLIC_COMPANY_LOCALE_ADRESS_POSTAL_CODE=${NEXT_PUBLIC_COMPANY_LOCALE_ADRESS_POSTAL_CODE}
ENV NEXT_PUBLIC_COMPANY_LOCALE_ADRESS_COUNTRY=${NEXT_PUBLIC_COMPANY_LOCALE_ADRESS_COUNTRY}
ENV NEXT_PUBLIC_COMPANY_AUTHOR=${NEXT_PUBLIC_COMPANY_AUTHOR}
ENV NEXT_PUBLIC_HOSTING_PROVIDER=${NEXT_PUBLIC_HOSTING_PROVIDER}
ENV NEXT_PUBLIC_HOSTING_URL=${NEXT_PUBLIC_HOSTING_URL}
ENV NEXT_PUBLIC_HOSTING_PROVIDER_ADRESSE=${NEXT_PUBLIC_HOSTING_PROVIDER_ADRESSE}
ENV NEXT_PUBLIC_HOSTING_PROVIDER_TEL=${NEXT_PUBLIC_HOSTING_PROVIDER_TEL}
ENV NEXT_PUBLIC_HOSTING_PROVIDER_URL=${NEXT_PUBLIC_HOSTING_PROVIDER_URL}
ENV NEXT_PUBLIC_MAINTENACE_WEBSITE_COST_PER_HOUR=${NEXT_PUBLIC_MAINTENACE_WEBSITE_COST_PER_HOUR}
ENV NEXT_PUBLIC_MAINTENACE_WEBSITE_COST_PER_YEAR=${NEXT_PUBLIC_MAINTENACE_WEBSITE_COST_PER_YEAR}
ENV NEXT_PUBLIC_MAINTENACE_ECOMMERCE_COST_PER_HOUR=${NEXT_PUBLIC_MAINTENACE_ECOMMERCE_COST_PER_HOUR}
ENV NEXT_PUBLIC_MAINTENACE_ECOMMERCE_COST_PER_YEAR=${NEXT_PUBLIC_MAINTENACE_ECOMMERCE_COST_PER_YEAR}
ENV NEXT_PUBLIC_MAKE_CONTRACT_CITY=${NEXT_PUBLIC_MAKE_CONTRACT_CITY}
ENV NEXT_PUBLIC_DEV_ECOMMERCE_COST_CMS=${NEXT_PUBLIC_DEV_ECOMMERCE_COST_CMS}
ENV NEXT_PUBLIC_DEV_ECOMMERCE_COST_HEALESS_CMS=${NEXT_PUBLIC_DEV_ECOMMERCE_COST_HEALESS_CMS}
ENV NEXT_PUBLIC_DEV_ECOMMERCE_COST_CUSTOM=${NEXT_PUBLIC_DEV_ECOMMERCE_COST_CUSTOM}
ENV NEXT_PUBLIC_DEV_WEBSITE_COST_CMS=${NEXT_PUBLIC_DEV_WEBSITE_COST_CMS}
ENV NEXT_PUBLIC_DEV_WEBSITE_COST_HEALESS_CMS=${NEXT_PUBLIC_DEV_WEBSITE_COST_HEALESS_CMS}
ENV NEXT_PUBLIC_DEV_WEBSITE_COST_CUSTOM=${NEXT_PUBLIC_DEV_WEBSITE_COST_CUSTOM}

ENV NODE_ENV=production

RUN npm run build && cache clean --force

# ========================
# Production stage
# ========================
FROM node:20-alpine AS production

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

# Copier uniquement le build final et les fichiers n√©cessaires
COPY --from=build /app/.next ./.next
COPY --from=build /app/public ./public

EXPOSE 3000

CMD ["npm", "start"]
